# 数据库表名修改说明

## 修改概述

已将数据库中的用户相关表名从 `sys_user` 修改为 `app_user`，同时保持 Java 实体类名称不变。

## 修改内容

### 1. 数据库表名变更

| 原表名 | 新表名 | 说明 |
|--------|--------|------|
| `sys_user` | `app_user` | 用户表 |
| `sys_user_activity_log` | `app_user_activity_log` | 用户活动日志表 |

### 2. 修改的文件

#### 2.1 Mapper XML 文件
- `src/main/resources/mapper/SysUserMapper.xml`
  - 所有 SQL 语句中的表名从 `sys_user` 改为 `app_user`
  - 包括 SELECT、INSERT、UPDATE、DELETE 语句

- `src/main/resources/mapper/AnalyticsMapper.xml`
  - 所有 SQL 语句中的表名从 `sys_user_activity_log` 改为 `app_user_activity_log`

#### 2.2 数据库初始化脚本
- `src/main/resources/test.sql`
  - 表创建语句中的表名修改
  - 外键约束引用修改
  - 测试数据插入语句修改

### 3. 保持不变的内容

#### 3.1 Java 实体类
- `SysUser.java` - 类名保持不变
- `SysUserActivityLog.java` - 类名保持不变

#### 3.2 Java 接口和实现
- `SysUserMapper.java` - 接口名保持不变
- `UserService.java` - 服务接口保持不变
- `UserServiceImpl.java` - 服务实现保持不变

#### 3.3 Controller 层
- 所有 Controller 中的 `SysUser` 类型引用保持不变

## 数据库表结构

### app_user 表结构
```sql
CREATE TABLE `app_user` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '用户ID',
    `username` VARCHAR(50) NOT NULL COMMENT '用户名/账号',
    `password` VARCHAR(255) NOT NULL COMMENT '密码（哈希存储）',
    `nickname` VARCHAR(50) DEFAULT NULL COMMENT '用户昵称',
    `phone_number` VARCHAR(20) DEFAULT NULL COMMENT '手机号码',
    `email` VARCHAR(100) DEFAULT NULL COMMENT '电子邮箱',
    `gender` TINYINT DEFAULT '0' COMMENT '性别 (0:未知, 1:男, 2:女)',
    `user_type` TINYINT NOT NULL DEFAULT '1' COMMENT '平台用户类型 (1:企业用户, 2:平台超级管理员)',
    `company_id` BIGINT DEFAULT NULL COMMENT '所属企业ID',
    `company_role` TINYINT NOT NULL DEFAULT '1' COMMENT '企业内部角色 (1:普通员工, 2:企业管理员)',
    `status` TINYINT NOT NULL DEFAULT '1' COMMENT '用户状态 (0:禁用, 1:正常)',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_username` (`username`),
    KEY `idx_company_id` (`company_id`),
    CONSTRAINT `fk_user_company` FOREIGN KEY (`company_id`) REFERENCES `sys_company` (`id`) ON DELETE SET NULL
);
```

### app_user_activity_log 表结构
```sql
CREATE TABLE `app_user_activity_log` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '日志ID',
    `user_id` BIGINT NOT NULL COMMENT '用户ID',
    `action_type` VARCHAR(50) NOT NULL COMMENT '操作类型',
    `target_type` VARCHAR(50) DEFAULT NULL COMMENT '目标类型',
    `target_id` BIGINT DEFAULT NULL COMMENT '目标ID',
    `ip_address` VARCHAR(45) DEFAULT NULL COMMENT 'IP地址',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    PRIMARY KEY (`id`),
    KEY `idx_user_id` (`user_id`),
    KEY `idx_action_type` (`action_type`),
    KEY `idx_created_at` (`created_at`),
    CONSTRAINT `fk_activity_user` FOREIGN KEY (`user_id`) REFERENCES `app_user` (`id`) ON DELETE CASCADE
);
```

## 外键关系

### 修改后的外键约束
1. `biz_news.author_id` → `app_user.id`
2. `biz_course.author_id` → `app_user.id`
3. `biz_meeting.creator_id` → `app_user.id`
4. `biz_meeting_registration.user_id` → `app_user.id`
5. `app_user_activity_log.user_id` → `app_user.id`

## 部署说明

### 1. 数据库迁移
如果数据库中已有数据，需要执行以下 SQL：

```sql
-- 重命名表
RENAME TABLE sys_user TO app_user;
RENAME TABLE sys_user_activity_log TO app_user_activity_log;

-- 更新外键约束
ALTER TABLE biz_news DROP FOREIGN KEY fk_news_author;
ALTER TABLE biz_news ADD CONSTRAINT fk_news_author FOREIGN KEY (author_id) REFERENCES app_user(id) ON DELETE CASCADE;

ALTER TABLE biz_course DROP FOREIGN KEY fk_course_author;
ALTER TABLE biz_course ADD CONSTRAINT fk_course_author FOREIGN KEY (author_id) REFERENCES app_user(id) ON DELETE CASCADE;

ALTER TABLE biz_meeting DROP FOREIGN KEY fk_meeting_creator;
ALTER TABLE biz_meeting ADD CONSTRAINT fk_meeting_creator FOREIGN KEY (creator_id) REFERENCES app_user(id) ON DELETE CASCADE;

ALTER TABLE biz_meeting_registration DROP FOREIGN KEY fk_reg_user;
ALTER TABLE biz_meeting_registration ADD CONSTRAINT fk_reg_user FOREIGN KEY (user_id) REFERENCES app_user(id) ON DELETE CASCADE;
```

### 2. 新数据库初始化
如果是全新的数据库，直接执行 `test.sql` 文件即可。

### 3. 应用部署
1. 重新编译项目：`mvn clean compile`
2. 启动应用：`mvn spring-boot:run`
3. 验证数据库连接和功能正常

## 验证清单

- [ ] 数据库表名已修改为 `app_user` 和 `app_user_activity_log`
- [ ] 外键约束已正确更新
- [ ] Mapper XML 文件中的 SQL 语句已更新
- [ ] 应用启动正常，无数据库连接错误
- [ ] 用户登录功能正常
- [ ] 用户管理功能正常
- [ ] 数据分析功能正常

## 注意事项

1. **备份数据**：在生产环境执行迁移前，请务必备份数据库
2. **测试环境**：建议先在测试环境验证修改的正确性
3. **停机时间**：表重命名操作可能需要短暂的停机时间
4. **回滚方案**：准备回滚脚本，以防出现问题

## 总结

本次修改只涉及数据库表名的变更，Java 代码层面的实体类、服务类、控制器等保持不变，确保了代码的兼容性和稳定性。修改后的系统将使用 `app_user` 和 `app_user_activity_log` 作为用户相关的数据库表名。 